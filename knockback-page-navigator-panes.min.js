/*
  knockback-page-navigator-panes.js 0.1.1
  (c) 2011, 2012 Kevin Malakoff - http://kmalakoff.github.com/knockback/
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
*/(function(){return function(e){return typeof define=="function"&&define.amd?define("knockback-page-navigator-panes",e):e.call(this)}(function(){var e,t,n,r,i,s,o,u,a;o=function(e,t){throw""+(a.isString(e)?e:e.constructor.name)+": "+t+" is missing"},u=function(e,t){throw""+(a.isString(e)?e:e.constructor.name)+": "+t+" is unexpected"};try{this.kb=r=!this.kb&&typeof require!="undefined"?require("knockback"):this.kb}catch(f){({})}this.kb||(this.kb=r||(r={})),this.Backbone||(this.Backbone=this.kb.Backbone);try{i=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko}catch(f){({})}return i||(i={}),i.observable||(i.dataFor=function(e){return null},i.removeNode=function(e){return $(e).remove()},i.observable=function(e){var t;return t=e,function(e){return arguments.length?t=e:t}},i.observableArray=function(e){var t;return t=i.observable(arguments.length?e:[]),t.push=function(){return t().push.apply(t(),arguments)},t.pop=function(){return t().pop.apply(t(),arguments)},t}),a=this._?this._:r._?r._:{},a.bindAll||(t=function(e,t){var n;return n=e[t],e[t]=function(){return n.apply(e,arguments)}},a.bindAll=function(e,n){var r,i,s,o;o=Array.prototype.slice.call(arguments,1);for(i=0,s=o.length;i<s;i++)r=o[i],t(e,r)}),a.isElement||(a.isElement=function(e){return e&&e.nodeType===1}),this.x$&&(this.$=this.x$),r.PageNavigatorPanes=function(){function e(e,t){t==null&&(t={}),e||o(this,"el"),a.bindAll(this,"hasHistory","activePage","previousPage","activeUrl","loadPage","goBack","dispatcher"),this.el=e.length?e[0]:e,$(this.el).addClass("page"),this.pane_navigator=new r.PaneNavigator(e,t)}return e.prototype.destroy=function(){return this.destroyed=!0,this.el=null,this.pane_navigator.destroy(),this.pane_navigator=null},e.prototype.hasHistory=function(){return!this.pane_navigator.no_history},e.prototype.activePage=function(){return this.pane_navigator.activePane()},e.prototype.activeUrl=function(){var e;return(e=this.pane_navigator.activePane())?e.url:null},e.prototype.previousPage=function(){return this.pane_navigator.previousPane()},e.prototype.previousUrl=function(){var e;return(e=this.pane_navigator.previousPage())?e.url:null},e.prototype.loadPage=function(e){var t,n;return e||o(this,"page info"),n=r.popOverrideTransition(),this.activeUrl()===window.location.hash?(t=this.activePage(),t.el||pane_navigator.ensureElement(t),t.el.parentNode!==this.el&&this.el.appendChild(t.el),t):this.pane_navigator.push(new r.Pane(e,window.location.hash),n?{transition:n}:null)},e.prototype.goBack=function(){var e,t;return t=r.popOverrideTransition(),this.pane_navigator.pop(),!(e=this.pane_navigator.activePane())||r.loadUrl(e.url),e},e.prototype.dispatcher=function(e){var t;return t=this,function(){t.destroyed||t.routeTriggered(this,e,arguments)}},e.prototype.routeTriggered=function(e,t,n){var r,i,s;s=window.location.hash;if((r=this.activePage())&&r.url===window.location.hash)return this.loadPage(r);if((i=this.previousPage())&&i.url===s)return this.goBack();if(t)return t.apply(e,n)},e}(),typeof exports!="undefined"&&(exports.PageNavigatorPanes=r.PageNavigatorPanes),i&&i.bindingHandlers&&(i.bindingHandlers.PageNavigatorPanes={init:function(e,t,n,s){var o,u;return o=i.utils.unwrapObservable(t()),"no_remove"in o||(o.no_remove=!0),u=new r.PageNavigatorPanes(e,o),r.utils.wrappedPageNavigator(e,u),i.utils.domNodeDisposal.addDisposeCallback(e,function(){return typeof o.unloaded=="function"&&o.unloaded(u),r.utils.wrappedPageNavigator(e,null)}),typeof o.loaded=="function"?o.loaded(u):void 0}}),s=this,e=100,n=function(e){var t,n,i;if(n=e.activePane()){i=n.el.parentNode;while(i&&i!==e.el)i=i.parentNode;if(i)return;e.clear()}t=$(e.el).children().filter(".pane");if(t.length)return e.push(new r.Pane(t[0]))},r.PaneNavigator=function(){function e(e,t){var r,u,a=this;e||o(this,"el");for(r in t)u=t[r],this[r]=u;this.panes=i.observableArray(),this.el=e&&e.length?e[0]:e,$(this.el).addClass("pane-navigator"),this.interval=s.setInterval(function(){return n(a)})}return e.prototype.destroy=function(){return s.clearInterval(this.interval),this.interval=null,this.el=null,this.clear({silent:!0})},e.prototype.clear=function(e){var t,n,r,i;e==null&&(e={}),this.cleanupTransition(!0),(t=this.activePane())&&t.destroy(this),n=this.panes(),i=n.slice(),i.pop(),n.splice(0,n.length);while(r=i.pop())r.el&&r.destroy(this);return e.silent||this.panes([]),this},e.prototype.activePane=function(){return this.paneAt(-1)},e.prototype.previousPane=function(){return this.paneAt(-2)},e.prototype.paneAt=function(e){var t,n;return n=this.panes(),t=e<0?n.length+e:e,t>=0&&t<n.length?n[t]:null},e.prototype.push=function(e,t){var n,r,i,s=this;t==null&&(t={});if(!e)return;return this.cleanupTransition(!0),"transition"in t&&(e.transition=t.transition),e.ensureElement(this.el),t.silent?this.panes().push(e):this.panes.push(e),i=this.previousPane(),r=!1,n=function(){var e;if(r)return;r=!0,s.cleanupTransition();if(i)return s.no_history?(e=s.panes(),e.splice(a.indexOf(e,i),1),i.destroy(s)):i.deactivate(s)},e&&(e.transition||this.transition)?(this.startTransition(e,i,n,!0),e.activate(this.el)):(e.activate(this.el),n()),e},e.prototype.pop=function(e){var t,n,r,i,s=this;return e==null&&(e={}),i=this.previousPane(),i?(i.ensureElement(),this.cleanupTransition(!0),t=this.activePane(),"transition"in e&&(t.transition=e.transition),this.panes.pop(),r=!1,n=function(){if(r)return;r=!0,s.cleanupTransition();if(t)return t.destroy(s)},t&&(t.transition||this.transition)?(this.startTransition(t,i,n,!1),i.activate(this.el)):(i.activate(this.el),n()),i):null},e.prototype.startTransition=function(e,t,n,i){var s,u,a,f,l,c,h,p,d,v;if(!e)return;e.transition&&e.transition.options&&(h=e.transition.options.use_previous),h&&(d=[t,e],e=d[0],t=d[1],i=!i),c=e.transition?e.transition:this.transition;if(!c)return null;typeof c=="string"&&(c={name:c}),r.active_transitions[c.name]||o(this,"transition "+c.name),f={forward:i};for(a in c)p=c[a],f[a]=p;return f.inverse&&(v=[t,e],e=v[0],t=v[1],f.forward=!f.forward),delete f.inverse,e&&e.activate(this.el),t&&t.activate(this.el),u={container:this.el,from:t?t.el:null,to:e?e.el:null,callback:n},l=new r.TransitionSavedState(u),!u.to||$(u.to).addClass("in-transition"),!u.from||$(u.from).addClass("in-transition"),s=this.el.clientHeight,s||(s=u.from?Math.max(u.to.clientHeight,u.from.clientHeight):u.to.clientHeight),$(this.el).css({overflow:"hidden",height:s}),this.active_transition={callback:n,start_state:l,info:u},new r.active_transitions[c.name](u,f)},e.prototype.cleanupTransition=function(e){var t;if(!this.active_transition)return;return t=this.active_transition,this.active_transition=null,e&&(!t.info.to||$(t.info.to).stopTransition(),!t.info.from||$(t.info.from).stopTransition()),t.start_state.restore(),t.callback()},e}(),typeof exports!="undefined"&&(exports.PaneNavigator=r.PaneNavigator),r.transitions||(r.transitions={}),a.indexOf||(a.indexOf=function(e,t){var n,r;for(n in e){r=e[n];if(r===t)return n}return-1}),r.utils||(r.utils={}),r.utils.wrappedPaneNavigator=function(e,t){return arguments.length===1||e.__kb_pane_navigator===t?e.__kb_pane_navigator:(e.__kb_pane_navigator&&e.__kb_pane_navigator.destroy(),e.__kb_pane_navigator=t,t)},this.$&&$.fn&&($.fn.findByPath=function(e){var t,n,r,i,s,o,u,a,f,l;o=[];for(u=0,f=this.length;u<f;u++){s=this[u],r=e.split("/"),i=s;for(a=0,l=r.length;a<l;a++){n=r[a],n[0]==="^"?(e=n.substring(1),e?(t=$(i).closest(e),i=t.length?t[0]:null):i=i.parentNode):n===".."?i=i.parentNode:(t=$(i).find(n),i=t.length?t[0]:null);if(!i)break}i&&o.push(i)}return $(o)},$.fn.findPaneNavigator=function(){var e,t,n,i,s,o,u,a,f,l,c;for(u=0,f=this.length;u<f;u++){n=this[u];if(o=n.getAttribute("data-path"))return e=this.findByPath(o),e.length&&(i=r.utils.wrappedPaneNavigator(e[0]))?i:null;t=$(n).parent();while(t.length&&!t.is("div"))t=t.parent();c=t.parent().find(".pane-navigator");for(a=0,l=c.length;a<l;a++){s=c[a];if(i=r.utils.wrappedPaneNavigator(s))return i}return e=$(n).closest(".pane-navigator"),e.length&&(i=r.utils.wrappedPaneNavigator(e[0]))?i:null}}),r.nextPane=function(e,t){var n,i,s,o;i=a.isElement(e)?e:e.currentTarget?e.currentTarget:t.currentTarget,o=$(i).findPaneNavigator();if(!o||!(n=o.activePane()))return;s=n.el;while(s=s.nextSibling)if(a.isElement(s)&&$(s).hasClass("pane"))break;if(s)return o.push(new r.Pane(s))},r.previousPane=function(e,t){var n,r;n=a.isElement(e)?e:e.currentTarget?e.currentTarget:t.currentTarget,r=$(n).findPaneNavigator();if(r&&r.activePane())return r.pop()},i.bindingHandlers&&(i.bindingHandlers.PaneNavigator={init:function(e,t,n,s){var o,u;return o=i.utils.unwrapObservable(t()),"no_remove"in o||(o.no_remove=!0),u=new r.PaneNavigator(e,o),r.utils.wrappedPaneNavigator(e,u),i.utils.domNodeDisposal.addDisposeCallback(e,function(){return r.utils.wrappedPaneNavigator(e,null)}),$(e).addClass("pane-navigator")}}),r.override_transitions=[],r.popOverrideTransition=function(){return r.override_transitions.length?r.override_transitions.pop():null},r.dispatchUrl=function(e){window.location.hash=e;if(window.Backbone&&window.Backbone.History.started)return window.Backbone.history.loadUrl(e);if(window.Path)return window.Path.dispatch(e)},r.loadUrl=function(e,t){return r.override_transitions.push(t),r.dispatchUrl(e)},r.loadUrlFn=function(e,t){return function(n,i){r.loadUrl(e,t),!n||!n.stopPropagation||(i=n),!i||!i.stopPropagation||(i.stopPropagation(),i.preventDefault())}},r.utils||(r.utils={}),r.utils.wrappedPageNavigator=function(e,t){return arguments.length===1||e.__kb_page_navigator===t?e.__kb_page_navigator:(e.__kb_page_navigator&&e.__kb_page_navigator.destroy(),e.__kb_page_navigator=t,t)},r.Pane=function(){function e(e,t){arguments.length&&(this.url=t),this.setInfo(e)}return e.prototype.destroy=function(e){return e==null&&(e={}),this.deactivate(e),this.removeElement(e,!0),this.create=null,this.el=null},e.prototype.setInfo=function(e){var t,n;if(a.isElement(e))this.el=e;else for(t in e)n=e[t],this[t]=n;this.el&&$(this.el).addClass("pane")},e.prototype.ensureElement=function(){var e;if(this.el)return this.el;this.create||o(this,"create"),e=this.create.apply(this,this.args),e&&this.setInfo(e),this.el||o(this,"element"),this.el&&$(this.el).addClass("pane")},e.prototype.removeElement=function(e,t){e==null&&(e={});if(!this.el)return this;if(e.no_remove)return;t||this.create&&!e.no_destroy?(i.removeNode(this.el),this.el=null):this.el.parentNode&&this.el.parentNode.removeChild(this.el)},e.prototype.activate=function(e){var t;this.ensureElement();if($(this.el).hasClass("active"))return;$(this.el).addClass("active"),this.el.parentNode!==e&&e.appendChild(this.el),t=this.view_model?this.view_model:i.dataFor(this.el),t&&t.activate&&t.activate(this)},e.prototype.deactivate=function(e){var t;e==null&&(e={});if(!this.el||!$(this.el).hasClass("active"))return;$(this.el).removeClass("active"),t=this.view_model?this.view_model:i.dataFor(this.el),t&&t.deactivate&&t.deactivate(this),this.removeElement(e)},e}(),typeof exports!="undefined"&&(exports.Pane=r.Pane),r})}).call(this);